<!DOCTYPE html>
<html lang="pt-BR" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Googol</title>
  <link rel="stylesheet" th:href="@{/css/style.css}" />
</head>
<body>
  <div class="container">
    <img th:src="@{/image/logo.jpeg}" alt="Logo" class="logo" />

    <!-- Campo de input compartilhado -->
    <input type="text" id="shared-query" class="search-bar" placeholder="Write here..." maxlength="200"/>

    <div class="actions">
      <!-- Formulário de pesquisa -->
      <form action="/search" method="get" class="form_class" onsubmit="disconnect(); copyQuery(this)">
        <input type="hidden" name="query" />
        <div class="action">
          <button type="submit" class="buttons">
            <img th:src="@{/image/lupa.png}" alt="Search" />
          </button>
          <p>Search</p>
        </div>
      </form>

      <!-- Formulário de inserção -->
      <form action="/indexing" method="get" class="form_class" onsubmit="disconnect(); copyQuery(this)">
        <input type="hidden" name="query" />
        <div class="action">
          <button type="submit" class="buttons">
            <img th:src="@{/image/adicionar.png}" alt="Insert" />
          </button>
          <p>Insert new URL</p>
        </div>
      </form>

      <!-- Link para estatísticas (mantém o WebSocket) -->
      <div class="action">
        <a th:href="@{/statistics}" class="action">
          <button type="button" class="buttons">
            <img th:src="@{/image/base-de-dados.png}" alt="Statistics" />
          </button>
        </a>
        <p>Statistics</p>
      </div>

      <!-- Formulário de URL específica -->
      <form action="/specificurl" method="get" class="form_class" onsubmit="disconnect(); copyQuery(this)">
        <input type="hidden" name="query" />
        <div class="action">
          <button type="submit" class="buttons">
            <img th:src="@{/image/arquivo.png}" alt="Search specific URL" />
          </button>
          <p>Search specific URL</p>
        </div>
      </form>

      <!-- Ação HackerNews -->
     <form action="/hacker" method="get" class="form_class" onsubmit="copyQuery(this)">
        <input type="hidden" name="query" />
        <div class="action">
        <button type="submit" class="buttons">
          <img th:src="@{/image/hacker.png}" alt="Hacker" />
        </button>
        <p>Index HackerNews</p>
      </div>
      </form>
    </div>
    </div>

    <!-- Bloco para exibir as estatísticas ao vivo -->
    <div class="results-box" style="margin-top: 30px;">
      <h3>Estatísticas em tempo real:</h3>
      <ul id="stats-list">
        <!-- Dados via WebSocket aparecerão aqui -->
      </ul>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

  <script>
    let stompClient = null;

    function connectToWebSocket() {
      const socket = new SockJS('/my-websocket');
      stompClient = Stomp.over(socket);

      stompClient.connect({}, function (frame) {
        console.log('Conectado ao WebSocket: ' + frame);

        stompClient.subscribe('/topic/statistics', function (message) {
          const statsList = JSON.parse(message.body);
          const ul = document.getElementById('stats-list');
          ul.innerHTML = '';
          statsList.forEach(function (item) {
            const li = document.createElement('li');
            li.textContent = item;
            // Se o item for título (termina com ":" ou contém "Ativo"), coloca negrito e remove marcador
            if (item.endsWith(':') || item.includes('Ativo')) {
              li.style.fontWeight = 'bold';
              li.style.listStyleType = 'none';
              li.style.marginTop = '10px';  // espaçamento opcional
            } else {
              // para os itens normais, remove só o marcador para ficar tudo alinhado
              li.style.listStyleType = 'none';
              li.style.marginLeft = '20px'; // indentação pra diferenciar
            }
            ul.appendChild(li);
          });
        });
      }, function (error) {
        console.log("Erro de WebSocket. Tentando reconectar em 3s...", error);
        setTimeout(connectToWebSocket, 3000);
      });
    }

    function disconnect() {
      if (stompClient !== null) {
        stompClient.disconnect(() => {
          console.log("WebSocket desconectado.");
        });
      }
    }

    function copyQuery(form) {
      const sharedInput = document.getElementById('shared-query');
      const hiddenInput = form.querySelector('input[name="query"]');
      hiddenInput.value = sharedInput.value;
    }

    window.addEventListener('load', connectToWebSocket);
  </script>
</body>
</html>